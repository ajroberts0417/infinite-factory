<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Crafting</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #palette {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        #canvas {
            width: 800px;
            height: 600px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .resource {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #fff;
            cursor: move;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .resource:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .resource[data-element="water"] {
            background-color: #3498db;
        }

        .resource[data-element="fire"] {
            background-color: #e74c3c;
        }

        .resource[data-element="earth"] {
            background-color: #27ae60;
        }

        .resource[data-element="air"] {
            background-color: #95a5a6;
        }

        #result {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <h1>Resource Crafting</h1>
    <div id="palette"></div>
    <div id="canvas"></div>
    <div id="result"></div>

    <script>
        const socket = io();
        const palette = document.getElementById('palette');
        const canvas = document.getElementById('canvas');
        const resultDiv = document.getElementById('result');

        let baseResources = ['water', 'fire', 'earth', 'air'];
        let canvasResources = [];

        function createResourceElement(resource) {
            const elem = document.createElement('div');
            elem.className = 'resource';
            elem.textContent = resource;
            elem.draggable = true;
            elem.dataset.element = resource;
            elem.addEventListener('dragstart', drag);
            return elem;
        }

        function updatePalette() {
            palette.innerHTML = '';
            baseResources.forEach(resource => {
                palette.appendChild(createResourceElement(resource));
            });
        }

        function drag(event) {
            event.dataTransfer.setData("text/plain", event.target.dataset.element);
        }

        canvas.addEventListener('dragover', (event) => {
            event.preventDefault();
        });

        canvas.addEventListener('drop', (event) => {
            event.preventDefault();
            const resource = event.dataTransfer.getData("text/plain");

            console.log("Dropped resource:", resource);

            const newElem = createResourceElement(resource);

            const canvasRect = canvas.getBoundingClientRect();
            const x = event.clientX - canvasRect.left;
            const y = event.clientY - canvasRect.top;

            newElem.style.position = 'absolute';
            newElem.style.left = `${x - 40}px`;
            newElem.style.top = `${y - 40}px`;
            newElem.style.zIndex = '10';  // Ensure it's above the canvas

            console.log("New element position:", newElem.style.left, newElem.style.top);

            const existingResource = document.elementFromPoint(event.clientX, event.clientY);
            if (existingResource && existingResource.classList.contains('resource') && existingResource !== newElem) {
                console.log("Crafting:", existingResource.dataset.element, resource);
                socket.emit('craft', [existingResource.dataset.element, resource]);
                existingResource.remove();
            } else {
                canvas.appendChild(newElem);
                console.log("Added new element to canvas");
            }

            // Log canvas children for debugging
            console.log("Canvas children:", canvas.children);
        });

        socket.on('craftResult', (result) => {
            if (result.error) {
                resultDiv.innerHTML = `<p style="color: red;">${result.error}</p>`;
            } else {
                const newResource = result.data.resource.replace(/[^a-zA-Z]/g, "").toLowerCase();
                resultDiv.innerHTML = `<p>New resource created: ${newResource}</p>`;
                console.log("New resource created:", newResource);
                if (!baseResources.includes(newResource)) {
                    baseResources.push(newResource);
                    updatePalette();
                }
                const newElem = createResourceElement(newResource);
                newElem.style.position = 'absolute';
                newElem.style.left = `${canvas.clientWidth / 2 - 40}px`;
                newElem.style.top = `${canvas.clientHeight / 2 - 40}px`;
                newElem.style.zIndex = '10';
                canvas.appendChild(newElem);
                console.log("Added crafted resource to canvas");
            }
        });

        updatePalette();
    </script>
</body>

</html>